<!--See https://nodered.org/docs/creating-nodes/node-html-->

<script type="text/javascript">

    const heaterConfig = {
        Sun: [
            { time: "01:00", temperature: 5 },
            { time: "05:00", temperature: 10 },
            { time: "10:00", temperature: 15 },
            { time: "12:00", temperature: 20 },
            { time: "17:00", temperature: 15 },
            { time: "20:00", temperature: 10 }
        ],
        Mon: [
            { time: "01:00", temperature: 5 + 1 },
            { time: "05:00", temperature: 10 + 1 },
            { time: "10:00", temperature: 15 + 1 },
            { time: "12:00", temperature: 20 + 1 },
            { time: "17:00", temperature: 15 + 1 },
            { time: "20:00", temperature: 10 + 1 }
        ],
        Tue: [
            { time: "01:00", temperature: 5 + 2 },
            { time: "05:00", temperature: 10 + 2 },
            { time: "10:00", temperature: 15 + 2 },
            { time: "12:00", temperature: 20 + 2 },
            { time: "17:00", temperature: 15 + 2 },
            { time: "20:00", temperature: 10 + 2 }
        ],
        Wed: [
            { time: "01:00", temperature: 5 + 3 },
            { time: "05:00", temperature: 10 + 3 },
            { time: "10:00", temperature: 15 + 3 },
            { time: "12:00", temperature: 20 + 3 },
            { time: "17:00", temperature: 15 + 3 },
            { time: "20:00", temperature: 10 + 3 }
        ],
        Thu: [
            { time: "01:00", temperature: 5 + 4 },
            { time: "05:00", temperature: 10 + 4 },
            { time: "10:00", temperature: 15 + 4 },
            { time: "12:00", temperature: 20 + 4 },
            { time: "17:00", temperature: 15 + 4 },
            { time: "20:00", temperature: 10 + 4 }
        ],
        Fri: [
            { time: "01:00", temperature: 5 + 5 },
            { time: "05:00", temperature: 10 + 5 },
            { time: "10:00", temperature: 15 + 5 },
            { time: "12:00", temperature: 20 + 5 },
            { time: "17:00", temperature: 15 + 5 },
            { time: "20:00", temperature: 10 + 5 }
        ],
        Sat: [
            { time: "01:00", temperature: 5 + 6 },
            { time: "05:00", temperature: 10 + 6 },
            { time: "10:00", temperature: 15 + 6 },
            { time: "12:00", temperature: 20 + 6 },
            { time: "17:00", temperature: 15 + 6 },
            { time: "20:00", temperature: 10 + 6 }
        ]

    };






    RED.nodes.registerType('det-heating-control', {
        category: 'dashboard',
        color: '#a6bbcf',
        defaults: {
            group: { type: 'ui_group', required: true },
            order: { value: 0 },
            width: {
                value: 0,
                validate: function (v) {
                    var valid = true
                    var width = v || 0;
                    var currentGroup = $('#node-input-group').val() || this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error", !valid);
                    return valid;
                }
            },
            height: { value: 0 },
            name: { value: "" },
            configText: { value: JSON.stringify(heaterConfig, null, 1) },
            debounceValue: { value: "1" },
        },
        inputs: 1,
        outputs: 5,
        icon: "file.png",
        label: function () {
            return this.name || "det-heating-control";
        },
        oneditprepare: function () {
            this.editor = RED.editor.createEditor({
                id: 'node-input-example-editor',
                mode: 'ace/mode/text',
                value: this.configText
            });
        },
        oneditsave: function () {
            this.configText = this.editor.getValue();
            this.editor.destroy();
            delete this.editor;
        },
        oneditcancel: function () {
            this.editor.destroy();
            delete this.editor;
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
        }
    });
</script>

<script type="text/html" data-template-name="det-heating-control">
    <div class="form-row" id="template-row-group">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</span></label>
        <input type="text" id="node-input-group">
    </div>    
    <div class="form-row" id="template-row-size">
        <label><i class="fa fa-object-group"></i> Size</span></label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>    
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-debounceValue"><i class="fa fa-tag"></i> DebounceValue</label>
        <input type="text" id="node-input-debounceValue" placeholder="DebounceValue">
    </div>    
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-example-editor"></div>
</script>

<script type="text/html" data-help-name="det-heating-control">
    <p>
        Input is a message containing the current room temperature:
        <code>
        const testMsg = {
            payload: '13'
                };
        </code>
        
        det-heating-control reads in the data and give as output the order to open or close the valve.

        Config-Text spezifies the time and temperatur table
        <code>
            {
                "Sun": [
                 {
                  "time": "01:00",
                  "temperature": 5
                 },
                 {
                  "time": "05:00",
                  "temperature": 10
                 },
                 {
                  "time": "10:00",
                  "temperature": 15
                 },
                 {
                  "time": "12:00",
                  "temperature": 20
                 },
                 {
                  "time": "17:00",
                  "temperature": 15
                 },
                 {
                  "time": "20:00",
                  "temperature": 10
                 }
                ],
                "Mon": [
                 {
                  "time": "01:00",
                  "temperature": 6
                 },
                 {
                  "time": "05:00",
                  "temperature": 11
                 },
                 {
                  "time": "10:00",
                  "temperature": 16
                 },
                 {
                  "time": "12:00",
                  "temperature": 21
                 },
                 {
                  "time": "17:00",
                  "temperature": 16
                 },
                 {
                  "time": "20:00",
                  "temperature": 11
                 }
                ],
                "Tue": [
                 {
                  "time": "01:00",
                  "temperature": 7
                 },
                 {
                  "time": "05:00",
                  "temperature": 12
                 },
                 {
                  "time": "10:00",
                  "temperature": 17
                 },
                 {
                  "time": "12:00",
                  "temperature": 22
                 },
                 {
                  "time": "17:00",
                  "temperature": 17
                 },
                 {
                  "time": "20:00",
                  "temperature": 12
                 }
                ],
                "Wed": [
                 {
                  "time": "01:00",
                  "temperature": 8
                 },
                 {
                  "time": "05:00",
                  "temperature": 13
                 },
                 {
                  "time": "10:00",
                  "temperature": 18
                 },
                 {
                  "time": "12:00",
                  "temperature": 23
                 },
                 {
                  "time": "17:00",
                  "temperature": 18
                 },
                 {
                  "time": "20:00",
                  "temperature": 13
                 }
                ],
                "Thu": [
                 {
                  "time": "01:00",
                  "temperature": 9
                 },
                 {
                  "time": "05:00",
                  "temperature": 14
                 },
                 {
                  "time": "10:00",
                  "temperature": 19
                 },
                 {
                  "time": "12:00",
                  "temperature": 24
                 },
                 {
                  "time": "17:00",
                  "temperature": 19
                 },
                 {
                  "time": "20:00",
                  "temperature": 14
                 }
                ],
                "Fri": [
                 {
                  "time": "01:00",
                  "temperature": 10
                 },
                 {
                  "time": "05:00",
                  "temperature": 15
                 },
                 {
                  "time": "10:00",
                  "temperature": 20
                 },
                 {
                  "time": "12:00",
                  "temperature": 25
                 },
                 {
                  "time": "17:00",
                  "temperature": 20
                 },
                 {
                  "time": "20:00",
                  "temperature": 15
                 }
                ],
                "Sat": [
                 {
                  "time": "01:00",
                  "temperature": 11
                 },
                 {
                  "time": "05:00",
                  "temperature": 16
                 },
                 {
                  "time": "10:00",
                  "temperature": 21
                 },
                 {
                  "time": "12:00",
                  "temperature": 26
                 },
                 {
                  "time": "17:00",
                  "temperature": 21
                 },
                 {
                  "time": "20:00",
                  "temperature": 16
                 }
                ]
               }
        </code>

        <br>
        
        
    </p>
    <h3>Outputs</h3>
     <ol class="node-ports">
         <li>OnOFF
             <dl class="message-properties">
                 <dt>Payload <span class="property-type">string</span></dt>
                 <dd>On/off of the controlled valve.</dd>
             </dl>
         </li>
         <li>TargetTemp
            <dl class="message-properties">
                <dt>Payload <span class="property-type">string</span></dt>
                <dd>Temperatur to be reached.</dd>
            </dl>
        </li>
        <li>Current table entry
            <dl class="message-properties">
                <dt>Payload <span class="property-type">string</span></dt>
                <dd>Current table entry which is active</dd>
            </dl>
        </li>         
        <li>Next switching time
            <dl class="message-properties">
                <dt>Payload <span class="property-type">string</span></dt>
                <dd>Next time table entry to be executed</dd>
            </dl>
        </li>      
        <li>Influx data stream
            <dl class="message-properties">
                <dt>Payload <span class="property-type">influx data</span></dt>
                <dd>Influx data stream</dd>
            </dl>
        </li>             
     </ol>
</script>